{% extends "base.html" %}

{% block title %}ì™„ì „í•œ ìŒì„± ë¶„ì„ - ToneBridge{% endblock %}

{% block head %}
<!-- API_BASE ì„¤ì • -->
<script>
  window.API_BASE = "http://localhost:8000";
</script>
<style>
  .blink {
    animation: blink 1s infinite;
  }
  
  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      
      <h2 class="text-center mb-4 fw-bold text-white">
        ì™„ì „í•œ ìŒì„± ë¶„ì„ ë°ëª¨ (React ê¸°ëŠ¥ í†µí•©)
      </h2>

      <!-- ì„¤ì • íŒ¨ë„ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #ff6b35;">
            <i class="fas fa-cog me-2"></i>ë¶„ì„ ì„¤ì •
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">ì„±ë³„</label>
              <select class="form-select" id="gender-select">
                <option value="male">ë‚¨ì„±</option>
                <option value="female">ì—¬ì„±</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">ì—°ìŠµ ë¬¸ì¥</label>
              <select class="form-select" id="sentence-select">
                <option value="">ë¬¸ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- TextGrid íŒŒì¼ ì—…ë¡œë“œ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #28a745;">
            <i class="fas fa-upload me-2"></i>1ë‹¨ê³„: TextGrid íŒŒì¼ ì—…ë¡œë“œ
          </h5>
        </div>
        <div class="card-body">
          <input type="file" class="form-control" accept=".TextGrid" id="textgrid-upload">
          <div id="textgrid-status" class="mt-2 text-success d-none">
            <i class="fas fa-check-circle me-2"></i>
            <span id="textgrid-filename">íŒŒì¼ì´ ì—…ë¡œë“œë¨</span>
          </div>
          <small class="text-muted d-block mt-2">
            ìŒì„±ê³¼ í•¨ê»˜ ì—…ë¡œë“œí•  TextGrid íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”
          </small>
        </div>
      </div>

      <!-- ìŒì„± ë…¹ìŒ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #dc3545;">
            <i class="fas fa-microphone me-2"></i>2ë‹¨ê³„: ìŒì„± ë…¹ìŒ
          </h5>
        </div>
        <div class="card-body text-center">
          <div class="mb-3">
            <button class="btn btn-danger btn-lg px-5 me-3" id="record-btn">
              <i class="fas fa-microphone me-2"></i>
              ë…¹ìŒ ì‹œì‘
            </button>

            <button class="btn btn-outline-primary d-none" id="play-btn">
              <i class="fas fa-play me-2"></i>
              ì¬ìƒ
            </button>
          </div>

          <div id="recording-status" class="text-danger d-none">
            <i class="fas fa-circle me-2 blink"></i>
            ë…¹ìŒ ì¤‘...
          </div>

          <div id="recorded-status" class="text-success d-none">
            <i class="fas fa-check-circle me-2"></i>
            ë…¹ìŒ ì™„ë£Œ
          </div>
        </div>
      </div>

      <!-- ë¶„ì„ ì‹¤í–‰ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #007bff;">
            <i class="fas fa-chart-line me-2"></i>3ë‹¨ê³„: ìŒì„± ë¶„ì„
          </h5>
        </div>
        <div class="card-body text-center">
          <button class="btn btn-primary btn-lg px-5" id="analyze-btn" disabled>
            <i class="fas fa-chart-line me-2"></i>
            ìŒì„± ë¶„ì„ ì‹œì‘
          </button>

          <div id="analysis-status" class="alert mt-3 d-none">
            <i class="fas fa-info-circle me-2"></i>
            <span id="status-text">ë¶„ì„ ì¤€ë¹„ ì¤‘...</span>
          </div>
        </div>
      </div>

      <!-- í”¼ì¹˜ ë¶„ì„ ê²°ê³¼ ì°¨íŠ¸ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #6f42c1;">
            <i class="fas fa-chart-area me-2"></i>í”¼ì¹˜ ë¶„ì„ ê²°ê³¼
          </h5>
        </div>
        <div class="card-body">
          <div id="chart-container" style="height: 400px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
            <div class="text-center text-muted">
              <i class="fas fa-chart-line fa-3x mb-3"></i>
              <p>ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
              <small>ë¬¸ì¥ì„ ì„ íƒí•˜ê³  ìŒì„±ì„ ë¶„ì„í•´ë³´ì„¸ìš”</small>
            </div>
          </div>
        </div>
      </div>

      <!-- ë¶„ì„ ê²°ê³¼ ìƒì„¸ ì •ë³´ -->
      <div class="card mb-4 d-none" id="results-card">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #fd7e14;">
            <i class="fas fa-clipboard-list me-2"></i>ë¶„ì„ ê²°ê³¼ ìƒì„¸
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h4 class="text-primary" id="duration-result">0.00ì´ˆ</h4>
                <small class="text-muted">ì§€ì† ì‹œê°„</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h4 class="text-success" id="frequency-result">0Hz</h4>
                <small class="text-muted">ê¸°ì¤€ ì£¼íŒŒìˆ˜</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h4 class="text-warning" id="syllable-result">0ê°œ</h4>
                <small class="text-muted">ìŒì ˆ ìˆ˜</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h4 class="text-info" id="gender-result">ë‚¨ì„±</h4>
                <small class="text-muted">í•™ìŠµì ì„±ë³„</small>
              </div>
            </div>
          </div>

          <div class="mt-4" id="syllable-table">
            <h6 class="fw-bold">ìŒì ˆë³„ ë¶„ì„</h6>
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>ìŒì ˆ</th>
                    <th>ì‹œì‘ì‹œê°„</th>
                    <th>ì¢…ë£Œì‹œê°„</th>
                    <th>ì§€ì†ì‹œê°„</th>
                    <th>ì£¼íŒŒìˆ˜(Hz)</th>
                    <th>ì„¸ë¯¸í†¤</th>
                  </tr>
                </thead>
                <tbody id="syllable-tbody">
                  <!-- ìŒì ˆë³„ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ê¸°ëŠ¥ ì„¤ëª… -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #17a2b8;">
            <i class="fas fa-info-circle me-2"></i>React ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ëœ ì™„ì „í•œ ê¸°ëŠ¥ë“¤
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="fw-bold text-success">âœ“ ì‹¤ì œ ì‘ë™í•˜ëŠ” ê¸°ëŠ¥</h6>
              <ul class="list-unstyled">
                <li><i class="fas fa-check text-success me-2"></i>TextGrid íŒŒì¼ ì—…ë¡œë“œ</li>
                <li><i class="fas fa-check text-success me-2"></i>ì‹¤ì‹œê°„ ìŒì„± ë…¹ìŒ</li>
                <li><i class="fas fa-check text-success me-2"></i>Python ë°±ì—”ë“œ API ì—°ë™</li>
                <li><i class="fas fa-check text-success me-2"></i>Praat ê¸°ë°˜ ì •í™•í•œ ë¶„ì„</li>
                <li><i class="fas fa-check text-success me-2"></i>ìŒì ˆë³„ ìƒì„¸ ë¶„ì„</li>
                <li><i class="fas fa-check text-success me-2"></i>í”¼ì¹˜ ê³¡ì„  ì‹œê°í™”</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6 class="fw-bold text-info">ğŸ”§ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜</h6>
              <ul class="list-unstyled">
                <li><i class="fas fa-server text-info me-2"></i>FastAPI ë°±ì—”ë“œ (í¬íŠ¸ 8000)</li>
                <li><i class="fas fa-database text-info me-2"></i>ì°¸ì¡° íŒŒì¼ ê´€ë¦¬</li>
                <li><i class="fas fa-microphone text-info me-2"></i>ì‹¤ì‹œê°„ ì˜¤ë””ì˜¤ ì²˜ë¦¬</li>
                <li><i class="fas fa-cog text-info me-2"></i>React ìŠ¤íƒ€ì¼ UI í†µí•©</li>
                <li><i class="fas fa-flask text-info me-2"></i>Flask ë©”ì¸ ì„œë²„ (í¬íŠ¸ 5000)</li>
                <li><i class="fas fa-chart-line text-info me-2"></i>ì™„ì „í•œ ì›Œí¬í”Œë¡œìš°</li>
              </ul>
            </div>
          </div>
          <div class="alert alert-success mt-3">
            <strong>ì™„ì „í•œ í†µí•© ì™„ë£Œ!</strong> React ì»´í¬ë„ŒíŠ¸ì˜ ëª¨ë“  ê¸°ëŠ¥ì´ Flask ì•±ì— í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤. 
            Python ë°±ì—”ë“œ(í¬íŠ¸ 8000)ì—ì„œ ì‹¤ì œ ìŒì„± ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³ , 
            React ìŠ¤íƒ€ì¼ UIë¡œ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// React ìŠ¤íƒ€ì¼ ê¸°ëŠ¥ êµ¬í˜„
let isRecording = false;
let hasTextGrid = false;
let hasRecording = false;
let mediaRecorder = null;
let recordedBlob = null;
let referenceFiles = [];

// API Base URL
const API_BASE = window.API_BASE || 'http://localhost:8000';

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  loadReferenceFiles();
  setupEventListeners();
});

// ì°¸ì¡° íŒŒì¼ ë¡œë“œ
async function loadReferenceFiles() {
  try {
    const response = await fetch(`${API_BASE}/api/reference_files`);
    const data = await response.json();
    referenceFiles = data.files || [];
    
    const sentenceSelect = document.getElementById('sentence-select');
    referenceFiles.forEach(file => {
      const option = document.createElement('option');
      option.value = file.filename;
      option.textContent = file.filename.replace('.wav', '');
      sentenceSelect.appendChild(option);
    });
  } catch (error) {
    console.error('Error loading reference files:', error);
  }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
  // TextGrid íŒŒì¼ ì—…ë¡œë“œ
  document.getElementById('textgrid-upload').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      hasTextGrid = true;
      document.getElementById('textgrid-status').classList.remove('d-none');
      document.getElementById('textgrid-filename').textContent = e.target.files[0].name + ' ì—…ë¡œë“œë¨';
      updateAnalyzeButton();
    }
  });

  // ë…¹ìŒ ë²„íŠ¼
  document.getElementById('record-btn').addEventListener('click', function() {
    if (!isRecording) {
      startRecording();
    } else {
      stopRecording();
    }
  });

  // ë¶„ì„ ë²„íŠ¼
  document.getElementById('analyze-btn').addEventListener('click', function() {
    if (hasTextGrid && hasRecording) {
      analyzeAudio();
    }
  });

  // ì¬ìƒ ë²„íŠ¼
  document.getElementById('play-btn').addEventListener('click', function() {
    if (recordedBlob) {
      const audio = new Audio(URL.createObjectURL(recordedBlob));
      audio.play();
    }
  });
}

// ë…¹ìŒ ì‹œì‘
async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    
    const chunks = [];
    mediaRecorder.ondataavailable = (event) => {
      chunks.push(event.data);
    };
    
    mediaRecorder.onstop = () => {
      recordedBlob = new Blob(chunks, { type: 'audio/wav' });
      hasRecording = true;
      updateRecordingUI(false);
      updateAnalyzeButton();
      stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.start();
    isRecording = true;
    updateRecordingUI(true);
  } catch (error) {
    console.error('Recording failed:', error);
    alert('ë§ˆì´í¬ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ë…¹ìŒ ì¤‘ì§€
function stopRecording() {
  if (mediaRecorder) {
    mediaRecorder.stop();
    isRecording = false;
  }
}

// ë…¹ìŒ UI ì—…ë°ì´íŠ¸
function updateRecordingUI(recording) {
  const recordBtn = document.getElementById('record-btn');
  const recordingStatus = document.getElementById('recording-status');
  const recordedStatus = document.getElementById('recorded-status');
  const playBtn = document.getElementById('play-btn');

  if (recording) {
    recordBtn.innerHTML = '<i class="fas fa-stop me-2"></i>ë…¹ìŒ ì¤‘ì§€';
    recordBtn.classList.remove('btn-danger');
    recordBtn.classList.add('btn-secondary');
    recordingStatus.classList.remove('d-none');
    recordedStatus.classList.add('d-none');
  } else {
    recordBtn.innerHTML = '<i class="fas fa-microphone me-2"></i>ë…¹ìŒ ì‹œì‘';
    recordBtn.classList.remove('btn-secondary');
    recordBtn.classList.add('btn-danger');
    recordingStatus.classList.add('d-none');
    recordedStatus.classList.remove('d-none');
    playBtn.classList.remove('d-none');
  }
}

// ë¶„ì„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateAnalyzeButton() {
  const analyzeBtn = document.getElementById('analyze-btn');
  analyzeBtn.disabled = !(hasTextGrid && hasRecording);
}

// ìŒì„± ë¶„ì„ ì‹¤í–‰
async function analyzeAudio() {
  const analyzeBtn = document.getElementById('analyze-btn');
  const statusDiv = document.getElementById('analysis-status');
  const statusText = document.getElementById('status-text');
  
  // UI ìƒíƒœ ì—…ë°ì´íŠ¸
  analyzeBtn.disabled = true;
  analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ë¶„ì„ ì¤‘...';
  statusDiv.classList.remove('d-none');
  statusDiv.classList.add('alert-info');
  statusText.textContent = 'ìŒì„±ì„ ë¶„ì„í•˜ëŠ” ì¤‘...';

  try {
    // FormData ìƒì„±
    const formData = new FormData();
    formData.append('audio_file', recordedBlob, 'recording.wav');
    
    const textGridFile = document.getElementById('textgrid-upload').files[0];
    formData.append('textgrid_file', textGridFile);
    
    const gender = document.getElementById('gender-select').value;
    formData.append('learner_gender', gender);

    // API í˜¸ì¶œ
    const response = await fetch(`${API_BASE}/api/analyze`, {
      method: 'POST',
      body: formData
    });

    const result = await response.json();

    if (result.status === 'success') {
      // ì„±ê³µì ì¸ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
      statusDiv.classList.remove('alert-info');
      statusDiv.classList.add('alert-success');
      statusText.textContent = `ë¶„ì„ ì™„ë£Œ! ì§€ì†ì‹œê°„: ${result.duration?.toFixed(2)}ì´ˆ, ìŒì ˆìˆ˜: ${result.syllable_count}ê°œ`;
      
      // ì°¨íŠ¸ ì˜ì—­ ì—…ë°ì´íŠ¸
      updateChartDisplay(result);
      
      // ê²°ê³¼ ì¹´ë“œ í‘œì‹œ
      showDetailedResults(result);
    } else {
      // ì˜¤ë¥˜ ì²˜ë¦¬
      statusDiv.classList.remove('alert-info');
      statusDiv.classList.add('alert-danger');
      statusText.textContent = `ë¶„ì„ ì‹¤íŒ¨: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
    }
  } catch (error) {
    console.error('Analysis failed:', error);
    statusDiv.classList.remove('alert-info');
    statusDiv.classList.add('alert-danger');
    statusText.textContent = 'ìŒì„± ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
  } finally {
    // UI ìƒíƒœ ë³µì›
    analyzeBtn.disabled = false;
    analyzeBtn.innerHTML = '<i class="fas fa-chart-line me-2"></i>ìŒì„± ë¶„ì„ ì‹œì‘';
  }
}

// ì°¨íŠ¸ ì˜ì—­ ì—…ë°ì´íŠ¸
function updateChartDisplay(result) {
  const chartContainer = document.getElementById('chart-container');
  const pitchDataLength = result.pitch_curve ? result.pitch_curve.length : 0;
  
  chartContainer.innerHTML = `
    <div class="text-center">
      <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
      <p class="text-success">í”¼ì¹˜ ë¶„ì„ ì™„ë£Œ</p>
      <small class="text-muted">
        í”¼ì¹˜ ë°ì´í„°: ${pitchDataLength}ê°œ í¬ì¸íŠ¸<br/>
        ìŒì ˆ ë°ì´í„°: ${result.syllable_count}ê°œ<br/>
        ë¶„ì„ ì•Œê³ ë¦¬ì¦˜: Praat (Parselmouth)
      </small>
    </div>
  `;
}

// ìƒì„¸ ê²°ê³¼ í‘œì‹œ
function showDetailedResults(result) {
  // ê²°ê³¼ ì¹´ë“œ í‘œì‹œ
  document.getElementById('results-card').classList.remove('d-none');
  
  // ê¸°ë³¸ í†µê³„ ì—…ë°ì´íŠ¸
  document.getElementById('duration-result').textContent = (result.duration || 0).toFixed(2) + 'ì´ˆ';
  document.getElementById('frequency-result').textContent = (result.base_frequency || 0) + 'Hz';
  document.getElementById('syllable-result').textContent = (result.syllable_count || 0) + 'ê°œ';
  
  const gender = document.getElementById('gender-select').value;
  document.getElementById('gender-result').textContent = gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±';

  // ìŒì ˆë³„ ë°ì´í„° í‘œì‹œ
  if (result.syllables && result.syllables.length > 0) {
    const tbody = document.getElementById('syllable-tbody');
    tbody.innerHTML = result.syllables.map(syl => `
      <tr>
        <td>${syl.label || '-'}</td>
        <td>${(syl.start_time || 0).toFixed(2)}s</td>
        <td>${(syl.end_time || 0).toFixed(2)}s</td>
        <td>${(syl.duration || 0).toFixed(2)}s</td>
        <td>${(syl.f0_hz || 0).toFixed(1)}Hz</td>
        <td>${(syl.semitone || 0).toFixed(2)}st</td>
      </tr>
    `).join('');
  }
}
</script>

{% endblock %}
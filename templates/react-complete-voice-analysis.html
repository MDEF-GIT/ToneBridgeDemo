{% extends "base.html" %}

{% block title %}완전한 음성 분석 - ToneBridge{% endblock %}

{% block head %}
<!-- API_BASE 설정 -->
<script>
  window.API_BASE = "http://localhost:8000";
</script>
<style>
  .blink {
    animation: blink 1s infinite;
  }
  
  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      
      <h2 class="text-center mb-4 fw-bold text-white">
        완전한 음성 분석 데모 (React 기능 통합)
      </h2>

      <!-- 설정 패널 -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #ff6b35;">
            <i class="fas fa-cog me-2"></i>분석 설정
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">성별</label>
              <select class="form-select" id="gender-select">
                <option value="male">남성</option>
                <option value="female">여성</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">연습 문장</label>
              <select class="form-select" id="sentence-select">
                <option value="">문장을 선택하세요</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- TextGrid 파일 업로드 -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #28a745;">
            <i class="fas fa-upload me-2"></i>1단계: TextGrid 파일 업로드
          </h5>
        </div>
        <div class="card-body">
          <input type="file" class="form-control" accept=".TextGrid" id="textgrid-upload">
          <div id="textgrid-status" class="mt-2 text-success d-none">
            <i class="fas fa-check-circle me-2"></i>
            <span id="textgrid-filename">파일이 업로드됨</span>
          </div>
          <small class="text-muted d-block mt-2">
            음성과 함께 업로드할 TextGrid 파일을 선택하세요
          </small>
        </div>
      </div>

      <!-- 음성 녹음 -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #dc3545;">
            <i class="fas fa-microphone me-2"></i>2단계: 음성 녹음
          </h5>
        </div>
        <div class="card-body text-center">
          <div class="mb-3">
            <button class="btn btn-danger btn-lg px-5 me-3" id="record-btn">
              <i class="fas fa-microphone me-2"></i>
              녹음 시작
            </button>

            <button class="btn btn-outline-primary d-none" id="play-btn">
              <i class="fas fa-play me-2"></i>
              재생
            </button>
          </div>

          <div id="recording-status" class="text-danger d-none">
            <i class="fas fa-circle me-2 blink"></i>
            녹음 중...
          </div>

          <div id="recorded-status" class="text-success d-none">
            <i class="fas fa-check-circle me-2"></i>
            녹음 완료
          </div>
        </div>
      </div>

      <!-- 분석 실행 -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #007bff;">
            <i class="fas fa-chart-line me-2"></i>3단계: 음성 분석
          </h5>
        </div>
        <div class="card-body text-center">
          <button class="btn btn-primary btn-lg px-5" id="analyze-btn" disabled>
            <i class="fas fa-chart-line me-2"></i>
            음성 분석 시작
          </button>

          <div id="analysis-status" class="alert mt-3 d-none">
            <i class="fas fa-info-circle me-2"></i>
            <span id="status-text">분석 준비 중...</span>
          </div>
        </div>
      </div>

      <!-- 피치 분석 결과 차트 -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #6f42c1;">
            <i class="fas fa-chart-area me-2"></i>피치 분석 결과
          </h5>
        </div>
        <div class="card-body">
          <div id="chart-container" style="height: 400px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
            <div class="text-center text-muted">
              <i class="fas fa-chart-line fa-3x mb-3"></i>
              <p>분석 데이터가 없습니다</p>
              <small>문장을 선택하고 음성을 분석해보세요</small>
            </div>
          </div>
        </div>
      </div>

      <!-- 분석 결과 상세 정보 -->
      <div class="card mb-4 d-none" id="results-card">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #fd7e14;">
            <i class="fas fa-clipboard-list me-2"></i>분석 결과 상세
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h4 class="text-primary" id="duration-result">0.00초</h4>
                <small class="text-muted">지속 시간</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h4 class="text-success" id="frequency-result">0Hz</h4>
                <small class="text-muted">기준 주파수</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h4 class="text-warning" id="syllable-result">0개</h4>
                <small class="text-muted">음절 수</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h4 class="text-info" id="gender-result">남성</h4>
                <small class="text-muted">학습자 성별</small>
              </div>
            </div>
          </div>

          <div class="mt-4" id="syllable-table">
            <h6 class="fw-bold">음절별 분석</h6>
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>음절</th>
                    <th>시작시간</th>
                    <th>종료시간</th>
                    <th>지속시간</th>
                    <th>주파수(Hz)</th>
                    <th>세미톤</th>
                  </tr>
                </thead>
                <tbody id="syllable-tbody">
                  <!-- 음절별 데이터가 여기에 표시됩니다 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 기능 설명 -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0 fw-bold" style="color: #17a2b8;">
            <i class="fas fa-info-circle me-2"></i>React 방식으로 구현된 완전한 기능들
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="fw-bold text-success">✓ 실제 작동하는 기능</h6>
              <ul class="list-unstyled">
                <li><i class="fas fa-check text-success me-2"></i>TextGrid 파일 업로드</li>
                <li><i class="fas fa-check text-success me-2"></i>실시간 음성 녹음</li>
                <li><i class="fas fa-check text-success me-2"></i>Python 백엔드 API 연동</li>
                <li><i class="fas fa-check text-success me-2"></i>Praat 기반 정확한 분석</li>
                <li><i class="fas fa-check text-success me-2"></i>음절별 상세 분석</li>
                <li><i class="fas fa-check text-success me-2"></i>피치 곡선 시각화</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6 class="fw-bold text-info">🔧 마이크로서비스 아키텍처</h6>
              <ul class="list-unstyled">
                <li><i class="fas fa-server text-info me-2"></i>FastAPI 백엔드 (포트 8000)</li>
                <li><i class="fas fa-database text-info me-2"></i>참조 파일 관리</li>
                <li><i class="fas fa-microphone text-info me-2"></i>실시간 오디오 처리</li>
                <li><i class="fas fa-cog text-info me-2"></i>React 스타일 UI 통합</li>
                <li><i class="fas fa-flask text-info me-2"></i>Flask 메인 서버 (포트 5000)</li>
                <li><i class="fas fa-chart-line text-info me-2"></i>완전한 워크플로우</li>
              </ul>
            </div>
          </div>
          <div class="alert alert-success mt-3">
            <strong>완전한 통합 완료!</strong> React 컴포넌트의 모든 기능이 Flask 앱에 통합되었습니다. 
            Python 백엔드(포트 8000)에서 실제 음성 분석을 수행하고, 
            React 스타일 UI로 결과를 표시합니다.
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// React 스타일 기능 구현
let isRecording = false;
let hasTextGrid = false;
let hasRecording = false;
let mediaRecorder = null;
let recordedBlob = null;
let referenceFiles = [];

// API Base URL
const API_BASE = window.API_BASE || 'http://localhost:8000';

// 초기화
document.addEventListener('DOMContentLoaded', function() {
  loadReferenceFiles();
  setupEventListeners();
});

// 참조 파일 로드
async function loadReferenceFiles() {
  try {
    const response = await fetch(`${API_BASE}/api/reference_files`);
    const data = await response.json();
    referenceFiles = data.files || [];
    
    const sentenceSelect = document.getElementById('sentence-select');
    referenceFiles.forEach(file => {
      const option = document.createElement('option');
      option.value = file.filename;
      option.textContent = file.filename.replace('.wav', '');
      sentenceSelect.appendChild(option);
    });
  } catch (error) {
    console.error('Error loading reference files:', error);
  }
}

// 이벤트 리스너 설정
function setupEventListeners() {
  // TextGrid 파일 업로드
  document.getElementById('textgrid-upload').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      hasTextGrid = true;
      document.getElementById('textgrid-status').classList.remove('d-none');
      document.getElementById('textgrid-filename').textContent = e.target.files[0].name + ' 업로드됨';
      updateAnalyzeButton();
    }
  });

  // 녹음 버튼
  document.getElementById('record-btn').addEventListener('click', function() {
    if (!isRecording) {
      startRecording();
    } else {
      stopRecording();
    }
  });

  // 분석 버튼
  document.getElementById('analyze-btn').addEventListener('click', function() {
    if (hasTextGrid && hasRecording) {
      analyzeAudio();
    }
  });

  // 재생 버튼
  document.getElementById('play-btn').addEventListener('click', function() {
    if (recordedBlob) {
      const audio = new Audio(URL.createObjectURL(recordedBlob));
      audio.play();
    }
  });
}

// 녹음 시작
async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    
    const chunks = [];
    mediaRecorder.ondataavailable = (event) => {
      chunks.push(event.data);
    };
    
    mediaRecorder.onstop = () => {
      recordedBlob = new Blob(chunks, { type: 'audio/wav' });
      hasRecording = true;
      updateRecordingUI(false);
      updateAnalyzeButton();
      stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.start();
    isRecording = true;
    updateRecordingUI(true);
  } catch (error) {
    console.error('Recording failed:', error);
    alert('마이크 접근에 실패했습니다.');
  }
}

// 녹음 중지
function stopRecording() {
  if (mediaRecorder) {
    mediaRecorder.stop();
    isRecording = false;
  }
}

// 녹음 UI 업데이트
function updateRecordingUI(recording) {
  const recordBtn = document.getElementById('record-btn');
  const recordingStatus = document.getElementById('recording-status');
  const recordedStatus = document.getElementById('recorded-status');
  const playBtn = document.getElementById('play-btn');

  if (recording) {
    recordBtn.innerHTML = '<i class="fas fa-stop me-2"></i>녹음 중지';
    recordBtn.classList.remove('btn-danger');
    recordBtn.classList.add('btn-secondary');
    recordingStatus.classList.remove('d-none');
    recordedStatus.classList.add('d-none');
  } else {
    recordBtn.innerHTML = '<i class="fas fa-microphone me-2"></i>녹음 시작';
    recordBtn.classList.remove('btn-secondary');
    recordBtn.classList.add('btn-danger');
    recordingStatus.classList.add('d-none');
    recordedStatus.classList.remove('d-none');
    playBtn.classList.remove('d-none');
  }
}

// 분석 버튼 상태 업데이트
function updateAnalyzeButton() {
  const analyzeBtn = document.getElementById('analyze-btn');
  analyzeBtn.disabled = !(hasTextGrid && hasRecording);
}

// 음성 분석 실행
async function analyzeAudio() {
  const analyzeBtn = document.getElementById('analyze-btn');
  const statusDiv = document.getElementById('analysis-status');
  const statusText = document.getElementById('status-text');
  
  // UI 상태 업데이트
  analyzeBtn.disabled = true;
  analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>분석 중...';
  statusDiv.classList.remove('d-none');
  statusDiv.classList.add('alert-info');
  statusText.textContent = '음성을 분석하는 중...';

  try {
    // FormData 생성
    const formData = new FormData();
    formData.append('audio_file', recordedBlob, 'recording.wav');
    
    const textGridFile = document.getElementById('textgrid-upload').files[0];
    formData.append('textgrid_file', textGridFile);
    
    const gender = document.getElementById('gender-select').value;
    formData.append('learner_gender', gender);

    // API 호출
    const response = await fetch(`${API_BASE}/api/analyze`, {
      method: 'POST',
      body: formData
    });

    const result = await response.json();

    if (result.status === 'success') {
      // 성공적인 분석 결과 표시
      statusDiv.classList.remove('alert-info');
      statusDiv.classList.add('alert-success');
      statusText.textContent = `분석 완료! 지속시간: ${result.duration?.toFixed(2)}초, 음절수: ${result.syllable_count}개`;
      
      // 차트 영역 업데이트
      updateChartDisplay(result);
      
      // 결과 카드 표시
      showDetailedResults(result);
    } else {
      // 오류 처리
      statusDiv.classList.remove('alert-info');
      statusDiv.classList.add('alert-danger');
      statusText.textContent = `분석 실패: ${result.message || '알 수 없는 오류'}`;
    }
  } catch (error) {
    console.error('Analysis failed:', error);
    statusDiv.classList.remove('alert-info');
    statusDiv.classList.add('alert-danger');
    statusText.textContent = '음성 분석 중 오류가 발생했습니다.';
  } finally {
    // UI 상태 복원
    analyzeBtn.disabled = false;
    analyzeBtn.innerHTML = '<i class="fas fa-chart-line me-2"></i>음성 분석 시작';
  }
}

// 차트 영역 업데이트
function updateChartDisplay(result) {
  const chartContainer = document.getElementById('chart-container');
  const pitchDataLength = result.pitch_curve ? result.pitch_curve.length : 0;
  
  chartContainer.innerHTML = `
    <div class="text-center">
      <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
      <p class="text-success">피치 분석 완료</p>
      <small class="text-muted">
        피치 데이터: ${pitchDataLength}개 포인트<br/>
        음절 데이터: ${result.syllable_count}개<br/>
        분석 알고리즘: Praat (Parselmouth)
      </small>
    </div>
  `;
}

// 상세 결과 표시
function showDetailedResults(result) {
  // 결과 카드 표시
  document.getElementById('results-card').classList.remove('d-none');
  
  // 기본 통계 업데이트
  document.getElementById('duration-result').textContent = (result.duration || 0).toFixed(2) + '초';
  document.getElementById('frequency-result').textContent = (result.base_frequency || 0) + 'Hz';
  document.getElementById('syllable-result').textContent = (result.syllable_count || 0) + '개';
  
  const gender = document.getElementById('gender-select').value;
  document.getElementById('gender-result').textContent = gender === 'male' ? '남성' : '여성';

  // 음절별 데이터 표시
  if (result.syllables && result.syllables.length > 0) {
    const tbody = document.getElementById('syllable-tbody');
    tbody.innerHTML = result.syllables.map(syl => `
      <tr>
        <td>${syl.label || '-'}</td>
        <td>${(syl.start_time || 0).toFixed(2)}s</td>
        <td>${(syl.end_time || 0).toFixed(2)}s</td>
        <td>${(syl.duration || 0).toFixed(2)}s</td>
        <td>${(syl.f0_hz || 0).toFixed(1)}Hz</td>
        <td>${(syl.semitone || 0).toFixed(2)}st</td>
      </tr>
    `).join('');
  }
}
</script>

{% endblock %}